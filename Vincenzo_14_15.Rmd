```{r}
library(recommenderlab)
library(dplyr)
library(ggplot2)
library(ggridges)
library(tidyr)
library(coop)
library(gridExtra)
```
Aufgabe: Reduziere den MovieLense Datensatz auf rund 400 Kunden 
und 700 Filme, indem du Filme und Kunden  mit sehr wenigen Ratings 
entfernst.
Untersuche und dokumentiere die Eigenschaften des reduzierten 
Datensatzes und beschreibe den Effekt der Datenreduktion:
  1.Anzahl Filme und Kunden sowie Sparsity vor und nach Datenreduktion
```{r}
data(MovieLense)
MovieLense_df <- as(MovieLense, "data.frame")
MovieLenseMeta_df <- as(MovieLenseMeta, "data.frame")
MOVIE_MIN_RATED = 700
USER_MIN_RATED = 400

movies_min_rated <- MovieLense_df %>%
  count(item) %>%
  arrange(desc(n)) %>%
  head(MOVIE_MIN_RATED) %>%
  select(item)

MovieLense_user_movies_reduced_df <- MovieLense_df %>%
  inner_join(movies_min_rated, by='item')

user_min_movies_rated <- MovieLense_user_movies_reduced_df %>%
  count(user) %>%
  arrange(desc(n)) %>%
  head(USER_MIN_RATED) %>%
  select(user)

MovieLense_user_movies_reduced_df <- MovieLense_user_movies_reduced_df %>%
  inner_join(user_min_movies_rated, by='user') 
```
```{r}
recommenderRegistry$get_entries(dataType = "realRatingMatrix")
# We have a few options

# Let's check some algorithms against each other
scheme <- recommenderlab::evaluationScheme(coerce(MovieLense_user_movies_reduced_df,MovieLense) , method = "split", train = 0.8,
                          given = 3, goodRating = 4)


algorithms <- list(
  "item-based CF" = list(name="IBCF", param=list(normalize = "Z-score"
                                                 ))
  
  )

# run algorithms, predict next n movies
results <- evaluate(scheme, algorithms, n=c(1, 3, 5, 10, 15, 20))

# Draw ROC curve
plot(results, annotate = 1:4, legend="topleft")

# See precision / recall
plot(results, "prec/rec", annotate=3)
```
```{r}
eval_reduced <- recommenderlab::evaluationScheme(data = coerce(MovieLense_user_movies_reduced_df, MovieLense), 
                                                 method="split", train=0.8, given=3)


IBCF_reduced <- Recommender(data = getData(eval_reduced, "train"), method = "IBCF", 
                            parameter = list(k = 30, method = "Cosine", na_as_zero=TRUE))

```


```{r}
get_n_list <- function(model, data, n){
  #' @description Function to return the top_n list recommended by a Model.
  #' @param model fitted recommender model
  #' @param data data to predict
  #' @param n number of top_n predictions.
  pred <- predict(object = model, newdata = data, n = n)
  
  pred_df <- data.frame(user = sort(rep(1:length(pred@items), pred@n)), 
  rating = unlist(pred@ratings), index = unlist(pred@items))
  pred_df
  pred_df$item <- pred@itemLabels[pred_df$index]
  pred_df$year <- MovieLenseMeta$year[pred_df$index]
  
  return (pred_df)
}
precision_recall_coverage_novelty <- function(top_n, test, train){
  #' @description Function, which returns precision, recall, coverage and novelty.
  #' @param top_n Top_n list generated by `get_n_list`
  #' @param test test data as data.frame
  #' @param train train data as data.frame
  
  # Dtype not possible between int fractional types:
  test = transform(test, user = as.numeric(user), item = as.character(item))
  train = transform(train, user = as.numeric(user), item = as.character(item))
  top_n = transform(top_n, user = as.numeric(user), item = as.character(item))
  
  test_top_n <- test %>% 
    left_join(top_n, by=c("user","item"))
    
  return (test_top_n)
}
```
```{r}
top_n = get_n_list(IBCF_reduced, getData(scheme, "unknown"), 15)
top_n

test = as(getData(scheme, "unknown"), 'data.frame')
test

```
```{r}
top_n_test = precision_recall_coverage_novelty(as(top_n, 'data.frame'), as(getData(scheme, "unknown"), 'data.frame'), as(getData(scheme, "train"), 'data.frame'))
```
```{r}
top_n
as(getData(scheme, "unknown"), 'data.frame')
```
```{r}
top_n_test = precision_recall_coverage_novelty(top_n, as(getData(scheme, "unknown"), 'data.frame'), as(getData(scheme, "train"), 'data.frame'))
top_n_test
```
```{r}
test = as(getData(scheme, "unknown"), 'data.frame')
train =  as(getData(scheme, "known"), 'data.frame')
top_n = get_n_list(IBCF_reduced, getData(scheme, "unknown"), 15)
test = transform(test, user = as.numeric(user), item = as.character(item))
train = transform(train, user = as.numeric(user), item = as.character(item))
top_n = transform(top_n, user = as.numeric(user), item = as.character(item))

train$user_item <- paste(train$user, train$item)
test$user_item = paste(test$user, test$item)
top_n$user_item = paste(top_n$user, top_n$item)
test_top_n <- inner_join(test, top_n, by = "user_item")
```
```{r}
test_top_n
```
```{r}
test
```

```{r}
test_top_n
```

